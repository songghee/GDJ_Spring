<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <!-- mapper namespace는 비우면 에러 -->
 <!-- namespace의 값은 중복x -->
<!-- 해당 mapper를 사용할 DAO의 풀패키지명으로 작성 -->
<mapper namespace="com.winter.app.regions.RegionDAO">

  <sql id="search3">
  	<!-- TITLE, CONTENTS, WRITER -->
  	WHERE
  	<choose>
  		<when test="kind=='kind1'">
  			TITLE LIKE '%'||#{search}||'%'
  		</when>
  		
  		<when test="kind=='kind2'">
  			CONTENTS LIKE '%'||#{search}||'%'
  		</when>
  		
  		<otherwise>
  			WRITER LIKE '%'||#{search}||'%'
  		</otherwise>
  	</choose>
  </sql>

  
  <sql id="search2">
  <bind name="p" value="'%'+_parameter.getSearch+'%'"/>
  	<!-- TITLE, CONTENTS, WRITER -->
  	<where>
  	<if test="kind=='kind1' or kind=='kind4'">
  	TITLE LIKE #{p}
  	</if>
  	
  	<if test="kind=='kind2' or kind=='kind4'">
  	OR CONTENTS LIKE '%'||#{search}||'%'
  	</if>
  	
  	<if test="kind=='kind3' or kind=='kind4'">
  	OR WRITER LIKE '%'||#{search}||'%'
  	</if>
  	</where>
  	
  	
  </sql>


  <sql id="search">
  	WHERE REGION_NAME LIKE '%'||#{search}||'%'
  </sql>
  
  <!-- Delete -->
  <delete id="delete" parameterType="RegionDTO">
  	DELETE REGIONS WHERE REGION_ID=#{region_id}
  	
  </delete>
 
  <!-- update -->
  <update id="update" parameterType="RegionDTO">
  	UPDATE REGIONS SET REGION_NAME=#{region_name}
  	WHERE REGION_ID=#{region_id}
  </update>
  
  <insert id="addFile" parameterType="RegionFileDTO">
  	INSERT INTO REGIONfILES
  	VALUES(FILE_SEQ.NEXTVAL,#{region_id}, #{fileName}, #{oriName})
  </insert>
  
  <!-- Insert -->
  <!-- SEQ: 테이블 매꾸기 -->
  <insert id="add" parameterType="RegionDTO">
  <!-- keyproperty: 속성 -->
  	<selectKey keyProperty="region_id" order="BEFORE" resultType="Long">
  		SELECT EMPLOYEES_SEQ.NEXTVAL FROM DUAL
  	</selectKey>
  	INSERT INTO REGIONS
  	VALUES(#{region_id}, #{region_name})
  </insert>
  
  <!-- detail -->
  <!-- id는DAO의 메서드명 -->
  <select id="getDetail" resultMap="getDetailResult" parameterType="RegionDTO">
  SELECT *
  FROM REGIONS R
  	LEFT OTER JOIN
  	REGIONFILES FR
  	USING (REGION_ID)
  WHERE REGION_ID=#{region_id}
  </select>
  
  <resultMap type="RegionDTO" id="getDetailResult">
  <!-- PK -->
  <id column="REGION_NAME" property="region_id"/>
  <!-- PK를 제외한 나머지 -->
  <result column="REGION_NAME" property="region_name"/>
  <!-- 1:1 -->
  <association property="regionFileDTO" javaType="RegionFileDTO">
  	<!-- PK -->
  	<id column="FILENAME" property="fileName"/>
  	<result column="ORINAME" property="oriName"/>
  </association>
  </resultMap>
  
  <!-- File List 1:N -->
  <select id="getListFiles" resultType="RegionFileDTO" parameterType="RegionDTO">
  	SELECT *FROM REGIONFILES
  	WHERE REGION_ID=?
  </select>
  
  
  <!-- getTotal -->
  <select id="getTotal" resultType="Long" parameterType="Pager">
  SELECT COUNT(REGION_ID) FROM REGIONS
  	<include refid="search"></include>
  </select>
  
  <!-- list -->
  
  <select id="getList" resultType="RegionDTO" parameterType="Pager">
  	SELECT * FROM
  	(
  		SELECT ROWNUM R, RG. * FROM
  			(
  				SELECT * FROM REGIONS
   				<include refid="search"/>
   				ORDER BY REGION_ID DESC
  			)RG
  	)
  	WHERE R BETWEEN #{startRow} AND #{lastRow}

  </select>
  
  <!-- <select id="getDetail" resultType="java.util.HashMap" parameterType="com.winter.app.regions.RegionDTO">
		SELECT REGION_ID, REGION_NAME FROM REGIONS WHERE REGION_ID=#{region_id}
	</select>
	
	list
	<select id="getList" resultType="java.util.HashMap">
		SELECT * FROM REGIONS
	</select> -->
</mapper>